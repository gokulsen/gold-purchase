<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gold Purchase Tracker</title>
<style>
  :root {
    --gold: #d4af37;
    --dark-gold: #b08d2a;
    --light-gold: #f1d36c;
    --black-bg: #121212;
    --gray: #cfcfcf;
    --white: #fff;
  }

  body {
    font-family: "Poppins", sans-serif;
    background: linear-gradient(135deg, #1c1c1c, #000000);
    margin: 0;
    color: var(--gray);
    min-height: 100vh;
  }

  /* --- Header bar with title + logout button --- */
  .header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 20px auto 10px;
    max-width: 1100px;
    padding: 0 10px;
  }

  .header-bar h1 {
    color: var(--gold);
    text-shadow: 0 0 10px var(--dark-gold);
    letter-spacing: 1px;
    margin: 0;
  }

  #logout {
    background: linear-gradient(90deg, #ff6b6b, #d32f2f);
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 10px 18px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
  }
  #logout:hover {
    transform: scale(1.05);
    background: linear-gradient(90deg, #d32f2f, #ff6b6b);
  }

  /* --- Layout & summary cards --- */
  .container { max-width: 1100px; margin: auto; padding: 20px; }
  .summary {
    display: flex; flex-wrap: wrap; gap: 15px;
    justify-content: space-around; margin-bottom: 30px;
  }
  .card {
    background: linear-gradient(145deg, #1a1a1a, #262626);
    border: 1px solid var(--dark-gold);
    border-radius: 15px;
    box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
    padding: 18px 25px;
    flex: 1 1 200px;
    text-align: center;
    transition: all 0.3s ease;
  }
  .card:hover {
    transform: translateY(-6px);
    box-shadow: 0 0 30px rgba(212, 175, 55, 0.5);
  }
  .card span {
    font-size: 1.4em;
    color: var(--light-gold);
    font-weight: bold;
  }
  .card input {
    background: transparent; border: 1px solid var(--gold);
    border-radius: 6px; color: var(--white);
    text-align: center; padding: 6px; width: 100px;
  }
  .card button {
    margin-left: 8px;
    background: linear-gradient(90deg, var(--gold), var(--light-gold));
    border: none; border-radius: 5px;
    padding: 6px 10px; cursor: pointer;
    font-weight: bold; transition: 0.2s;
  }
  .card button:hover {
    background: linear-gradient(90deg, var(--light-gold), var(--gold));
    transform: scale(1.05);
  }

  /* --- Forms --- */
  #addForm, #loginForm {
    display: flex; flex-wrap: wrap; gap: 10px;
    justify-content: center; margin-bottom: 25px;
  }
  input, button {
    padding: 10px 12px; font-size: 14px;
    border-radius: 8px; border: 1px solid var(--dark-gold);
    background: #1e1e1e; color: var(--white);
    outline: none;
  }
  input:focus {
    border-color: var(--gold);
    box-shadow: 0 0 5px var(--gold);
  }
  button {
    background: linear-gradient(90deg, var(--gold), var(--light-gold));
    color: #000; font-weight: bold;
    border: none; cursor: pointer; transition: all 0.3s;
  }

  /* --- Table --- */
  table {
    width: 100%; border-collapse: collapse;
    background: #1e1e1e; border-radius: 12px;
    overflow: hidden; box-shadow: 0 0 25px rgba(212, 175, 55, 0.2);
  }
  th, td { padding: 12px 15px; text-align: center; }
  th { background: linear-gradient(90deg, var(--gold), var(--dark-gold)); color: #000; }
  tr:hover { background: rgba(212,175,55,0.1); }
  .action-btn {
    padding: 6px 12px; border-radius: 5px; border: none;
    cursor: pointer; font-weight: bold; margin: 0 2px; transition: 0.2s;
  }
  .edit-btn { background: linear-gradient(90deg, #17a2b8, #138496); color: #fff; }
  .delete-btn { background: linear-gradient(90deg, #dc3545, #c82333); color: #fff; }

  /* --- Login box --- */
  #loginDiv {
    background: #1b1b1b; border: 1px solid var(--dark-gold);
    padding: 30px; border-radius: 10px;
    box-shadow: 0 0 20px rgba(212,175,55,0.2);
    max-width: 400px; margin: 50px auto; text-align: center;
  }
  a { color: var(--light-gold); }
</style>
</head>
<body>

<!-- Header Bar -->
<div class="header-bar">
  <h1>Gold Purchase Tracker</h1>
  <button id="logout" style="display:none;">Logout</button>
</div>

<div class="container">

<!-- LOGIN FORM -->
<div id="loginDiv">
<form id="loginForm">
  <input type="email" id="loginEmail" placeholder="Email" required>
  <input type="password" id="loginPassword" placeholder="Password" required>
  <button type="submit">Login</button>
</form>
<p>Don’t have an account? <a href="#" id="signupLink">Sign up</a></p>
</div>

<!-- MAIN APP -->
<div id="appDiv" style="display:none;">
<div class="summary">
  <div class="card">Total Gold: <span id="totalGold">0</span> g</div>
  <div class="card">Total Cost: ₹<span id="totalCost">0</span></div>
  <div class="card">
    Today's Gold Price: ₹<input type="number" id="todayPrice" step="0.01" value="0">
    <button id="savePrice">Save</button>
  </div>
  <div class="card">Profit/Loss: ₹<span id="profitLoss">0</span></div>
  <div class="card">Profit/Loss %: <span id="profitLossPercent">0</span>%</div>
  <div class="card">Current Value: ₹<span id="currentValue">0</span></div>
</div>

<form id="addForm">
  <input type="date" id="purchaseDate" required>
  <input type="number" step="0.01" id="amount" placeholder="Amount ₹" required>
  <input type="number" step="0.001" id="gold" placeholder="Gold g" required>
  <button type="submit">Add Purchase</button>
</form>

<table>
<thead>
<tr>
  <th>Purchase Date</th>
  <th>Amount (₹)</th>
  <th>Gold (g)</th>
  <th>Actions</th>
</tr>
</thead>
<tbody id="purchaseTable"></tbody>
</table>
</div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const SUPABASE_URL = 'https://febpaanqrqgrnbyrvfxx.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlYnBhYW5xcnFncm5ieXJ2Znh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NDUzNzMsImV4cCI6MjA3NjUyMTM3M30.dFyrWiNKqGCVDGLN9HU2IyRuI6rqAJaZGwRQjXri3mQ'
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

const loginDiv = document.getElementById('loginDiv')
const appDiv = document.getElementById('appDiv')
const loginForm = document.getElementById('loginForm')
const signupLink = document.getElementById('signupLink')
const logoutBtn = document.getElementById('logout')
const addForm = document.getElementById('addForm')
const purchaseTable = document.getElementById('purchaseTable')
const totalGoldEl = document.getElementById('totalGold')
const totalCostEl = document.getElementById('totalCost')
const todayPriceInput = document.getElementById('todayPrice')
const profitLossEl = document.getElementById('profitLoss')
const profitLossPercentEl = document.getElementById('profitLossPercent')
const currentValueEl = document.getElementById('currentValue')
const savePriceBtn = document.getElementById('savePrice')
let editingId = null

async function checkUser() {
  const { data } = await supabase.auth.getSession()
  if (data.session) showApp()
}
checkUser()

loginForm.addEventListener('submit', async e => {
  e.preventDefault()
  const email = document.getElementById('loginEmail').value
  const password = document.getElementById('loginPassword').value
  const { error } = await supabase.auth.signInWithPassword({ email, password })
  if (error) return alert(error.message)
  showApp()
})

signupLink.addEventListener('click', async () => {
  const email = prompt('Enter email:')
  const password = prompt('Enter password:')
  if (!email || !password) return
  const { error } = await supabase.auth.signUp({ email, password })
  if (error) alert(error.message)
  else alert('Signup successful! Please log in.')
})

logoutBtn.addEventListener('click', async () => {
  await supabase.auth.signOut()
  location.reload()
})

function showApp() {
  loginDiv.style.display = 'none'
  appDiv.style.display = 'block'
  logoutBtn.style.display = 'inline-block'
  loadPurchases()
  loadGoldPrice()
}

async function loadGoldPrice() {
  const { data } = await supabase.from('gold_price').select('*').order('id', { ascending: false }).limit(1)
  if (data.length > 0 && data[0].price > 0) {
    todayPriceInput.value = data[0].price
    calculateSummary()
  }
}

savePriceBtn.addEventListener('click', async () => {
  const price = parseFloat(todayPriceInput.value)
  if (isNaN(price) || price <= 0) return alert('Enter a valid gold price')
  await supabase.from('gold_price').insert([{ price }])
  alert('Gold price saved successfully!')
  calculateSummary()
})

async function loadPurchases() {
  const { data } = await supabase.from('gold_purchases').select('*').order('purchase_date', { ascending: true })
  purchaseTable.innerHTML = ''
  data.forEach(addRow)
  calculateSummary()
}

function addRow(p) {
  const row = document.createElement('tr')
  row.dataset.id = p.id
  row.innerHTML = `
    <td>${p.purchase_date}</td>
    <td>₹${parseFloat(p.amount).toFixed(2)}</td>
    <td>${parseFloat(p.gold).toFixed(3)} g</td>
    <td>
      <button class="action-btn edit-btn" onclick="editRow(${p.id})">Edit</button>
      <button class="action-btn delete-btn" onclick="deleteRow(${p.id})">Delete</button>
    </td>`
  purchaseTable.appendChild(row)
}

function calculateSummary() {
  let totalGold = 0, totalCost = 0
  purchaseTable.querySelectorAll('tr').forEach(row => {
    totalCost += parseFloat(row.cells[1].innerText.replace('₹', '')) || 0
    totalGold += parseFloat(row.cells[2].innerText.replace(' g', '')) || 0
  })

  totalGoldEl.innerText = totalGold.toFixed(3)
  totalCostEl.innerText = totalCost.toFixed(2)

  const todayPrice = parseFloat(todayPriceInput.value)
  if (!todayPrice || todayPrice <= 0 || totalGold <= 0 || totalCost <= 0) {
    profitLossEl.innerText = "0.00"
    profitLossPercentEl.innerText = "0.00"
    currentValueEl.innerText = totalCost.toFixed(2)
    profitLossEl.style.color = "#ccc"
    profitLossPercentEl.style.color = "#ccc"
    return
  }

  const currentValue = totalGold * todayPrice
  const profitLoss = currentValue - totalCost
  const profitPercent = totalCost > 0 ? (profitLoss / totalCost) * 100 : 0

  profitLossEl.innerText = profitLoss.toFixed(2)
  profitLossPercentEl.innerText = profitPercent.toFixed(2)
  currentValueEl.innerText = currentValue.toFixed(2)

  profitLossEl.style.color = profitLoss >= 0 ? '#00ff7f' : '#ff4d4d'
  profitLossPercentEl.style.color = profitLoss >= 0 ? '#00ff7f' : '#ff4d4d'
}

todayPriceInput.addEventListener('input', calculateSummary)
</script>
</body>
</html>
