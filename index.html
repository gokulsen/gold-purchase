<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gold Purchase Tracker</title>
<style>
:root {
  --gold: #d4af37;
  --light-gold: #f6e27a;
  --dark-gold: #b08d2a;
  --black: #0d0d0d;
  --gray: #ddd;
  --white: #fff;
}
body {
  font-family: "Poppins", sans-serif;
  background: linear-gradient(135deg, #000000, #1b1b1b);
  color: var(--gray);
  margin: 0;
  min-height: 100vh;
}

/* Header */
.header-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(90deg, var(--gold), var(--dark-gold));
  color: #000;
  padding: 15px 25px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.4);
}
.header-bar h1 {
  font-size: 1.6em;
  margin: 0;
  color: #000;
  text-shadow: 0 0 10px rgba(212,175,55,0.6);
}
#userInfo {
  font-weight: bold;
  color: #000;
  margin-right: 15px;
}
#logout {
  background: #000;
  border: 1px solid var(--gold);
  color: var(--gold);
  border-radius: 6px;
  padding: 8px 14px;
  cursor: pointer;
  font-weight: 600;
  transition: 0.3s;
}
#logout:hover {
  background: var(--gold);
  color: #000;
}

/* Layout */
.container { max-width: 1100px; margin: 20px auto; padding: 15px; }

/* Summary cards */
.summary {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  justify-content: space-around;
  margin-bottom: 25px;
}
.card {
  flex: 1 1 200px;
  background: linear-gradient(145deg, #111, #1c1c1c);
  border: 1px solid var(--dark-gold);
  border-radius: 12px;
  box-shadow: 0 0 15px rgba(212,175,55,0.2);
  padding: 15px;
  text-align: center;
  transition: transform 0.2s ease, box-shadow 0.3s;
}
.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 0 25px rgba(212,175,55,0.4);
}
.card span {
  display: block;
  font-weight: bold;
  font-size: 1.2em;
  color: var(--light-gold);
}
.card input {
  width: 120px;
  padding: 6px;
  text-align: center;
  border: 1px solid var(--gold);
  border-radius: 6px;
  background: #000;
  color: var(--light-gold);
}
.card button {
  margin-left: 8px;
  background: linear-gradient(90deg, var(--gold), var(--dark-gold));
  border: none;
  border-radius: 5px;
  padding: 6px 10px;
  cursor: pointer;
  font-weight: 600;
  color: #000;
}
.card button:hover {
  background: linear-gradient(90deg, var(--dark-gold), var(--gold));
}

/* Forms */
#addForm, #loginForm {
  display: flex; flex-wrap: wrap;
  gap: 10px; justify-content: center;
  margin-bottom: 25px;
}
input, button {
  padding: 10px 12px;
  font-size: 14px;
  border-radius: 8px;
  outline: none;
}
input {
  border: 1px solid var(--dark-gold);
  background: #111;
  color: var(--light-gold);
}
input:focus {
  border-color: var(--gold);
  box-shadow: 0 0 5px var(--gold);
}
button {
  background: linear-gradient(90deg, var(--gold), var(--dark-gold));
  color: #000; border: none;
  font-weight: 600;
  cursor: pointer; transition: 0.2s;
}
button:hover {
  transform: scale(1.05);
}

/* Table */
table {
  width: 100%;
  border-collapse: collapse;
  background: #111;
  border-radius: 12px;
  box-shadow: 0 0 15px rgba(212,175,55,0.2);
  overflow: hidden;
}
th, td {
  padding: 12px 15px;
  text-align: center;
  color: var(--gray);
}
th {
  background: linear-gradient(90deg, var(--gold), var(--dark-gold));
  color: #000;
}
tr:nth-child(even) { background: #1a1a1a; }
tr:hover { background: rgba(212,175,55,0.1); }
.action-btn {
  padding: 6px 10px; border-radius: 5px;
  border: none; cursor: pointer;
  font-weight: bold; margin: 0 3px;
}
.edit-btn { background: #17a2b8; color: #fff; }
.delete-btn { background: #dc3545; color: #fff; }

/* Login box */
#loginDiv {
  background: #111;
  border: 1px solid var(--gold);
  border-radius: 10px;
  padding: 30px;
  box-shadow: 0 0 15px rgba(212,175,55,0.3);
  max-width: 400px;
  margin: 80px auto;
  text-align: center;
}
#loginDiv h2 { color: var(--gold); }
a { color: var(--light-gold); }

/* Responsive */
@media (max-width: 768px) {
  .summary { flex-direction: column; }
  table { font-size: 13px; }
  .card { flex: 1 1 100%; }
}
</style>
</head>
<body>

<div class="header-bar">
  <h1>üèÜ Gold Purchase Tracker</h1>
  <div>
    <span id="userInfo"></span>
    <button id="logout" style="display:none;">Logout</button>
  </div>
</div>

<div class="container">
  <!-- LOGIN -->
  <div id="loginDiv">
    <h2>Login</h2>
    <form id="loginForm">
      <input type="email" id="loginEmail" placeholder="Email" required>
      <input type="password" id="loginPassword" placeholder="Password" required>
      <button type="submit">Login</button>
    </form>
    <p>Don‚Äôt have an account? <a href="#" id="signupLink">Sign up</a></p>
  </div>

  <!-- MAIN APP -->
  <div id="appDiv" style="display:none;">
    <div class="summary">
      <div class="card">Total Gold <span id="totalGold">0</span> g</div>
      <div class="card">Total Cost ‚Çπ<span id="totalCost">0</span></div>
      <div class="card">
        Today's Price ‚Çπ<input type="number" id="todayPrice" step="0.01" value="0">
        <button id="savePrice">Save</button>
        <small id="lastUpdated" style="display:block; margin-top:4px; color:#aaa;"></small>
      </div>
      <div class="card">Profit/Loss ‚Çπ<span id="profitLoss">0</span></div>
      <div class="card">Profit % <span id="profitLossPercent">0</span>%</div>
      <div class="card">Current Value ‚Çπ<span id="currentValue">0</span></div>
    </div>

    <form id="addForm">
      <input type="date" id="purchaseDate" required>
      <input type="number" step="0.01" id="amount" placeholder="Amount ‚Çπ" required>
      <input type="number" step="0.001" id="gold" placeholder="Gold (g)" required>
      <button type="submit">Add Purchase</button>
    </form>

    <table>
      <thead>
        <tr>
          <th>Purchase Date</th>
          <th>Amount (‚Çπ)</th>
          <th>Gold (g)</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="purchaseTable"></tbody>
    </table>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabase = createClient(
  'https://febpaanqrqgrnbyrvfxx.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlYnBhYW5xcnFncm5ieXJ2Znh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NDUzNzMsImV4cCI6MjA3NjUyMTM3M30.dFyrWiNKqGCVDGLN9HU2IyRuI6rqAJaZGwRQjXri3mQ'
)

const loginDiv = document.getElementById('loginDiv')
const appDiv = document.getElementById('appDiv')
const loginForm = document.getElementById('loginForm')
const signupLink = document.getElementById('signupLink')
const logoutBtn = document.getElementById('logout')
const userInfo = document.getElementById('userInfo')
const addForm = document.getElementById('addForm')
const purchaseTable = document.getElementById('purchaseTable')
const totalGoldEl = document.getElementById('totalGold')
const totalCostEl = document.getElementById('totalCost')
const todayPriceInput = document.getElementById('todayPrice')
const profitLossEl = document.getElementById('profitLoss')
const profitLossPercentEl = document.getElementById('profitLossPercent')
const currentValueEl = document.getElementById('currentValue')
const savePriceBtn = document.getElementById('savePrice')
const lastUpdatedEl = document.getElementById('lastUpdated')

async function checkUser() {
  const { data } = await supabase.auth.getSession()
  if (data.session) showApp(data.session.user)
}
checkUser()

loginForm.addEventListener('submit', async e => {
  e.preventDefault()
  const email = document.getElementById('loginEmail').value
  const password = document.getElementById('loginPassword').value
  const { data, error } = await supabase.auth.signInWithPassword({ email, password })
  if (error) return alert(error.message)
  showApp(data.user)
})

signupLink.addEventListener('click', async () => {
  const email = prompt('Enter email:')
  const password = prompt('Enter password:')
  if (!email || !password) return
  const { error } = await supabase.auth.signUp({ email, password })
  if (error) alert(error.message)
  else alert('Signup successful! Please log in.')
})

logoutBtn.addEventListener('click', async () => {
  await supabase.auth.signOut()
  location.reload()
})

function showApp(user) {
  loginDiv.style.display = 'none'
  appDiv.style.display = 'block'
  logoutBtn.style.display = 'inline-block'
  userInfo.textContent = `Welcome, ${user.email}`
  loadPurchases()
  loadGoldPrice()
}

async function loadGoldPrice() {
  const { data } = await supabase.from('gold_price').select('*').order('price_date', { ascending: false }).limit(1)
  if (data.length > 0) {
    todayPriceInput.value = data[0].price
    lastUpdatedEl.textContent = `Last updated: ${data[0].price_date}`
    calculateSummary()
  }
}

savePriceBtn.addEventListener('click', async () => {
  const price = parseFloat(todayPriceInput.value)
  if (isNaN(price) || price <= 0) return alert('Enter a valid gold price')
  const today = new Date().toISOString().split('T')[0]

  const { error } = await supabase
    .from('gold_price')
    .upsert([{ price_date: today, price }], { onConflict: ['price_date'] })

  if (error) {
    alert('Error saving price: ' + error.message)
  } else {
    alert('Gold price saved successfully!')
    loadGoldPrice()
  }
})

async function loadPurchases() {
  const { data } = await supabase.from('gold_purchases').select('*').order('purchase_date', { ascending: true })
  purchaseTable.innerHTML = ''
  data.forEach(addRow)
  calculateSummary()
}

function formatCurrency(num) {
  return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(num)
}
function formatDate(d) {
  const date = new Date(d)
  return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })
}
function addRow(p) {
  const row = document.createElement('tr')
  row.dataset.id = p.id
  row.innerHTML = `
    <td>${formatDate(p.purchase_date)}</td>
    <td>${formatCurrency(p.amount)}</td>
    <td>${parseFloat(p.gold).toFixed(3)} g</td>
    <td>
      <button class="action-btn edit-btn" onclick="editRow(${p.id})">Edit</button>
      <button class="action-btn delete-btn" onclick="deleteRow(${p.id})">Delete</button>
    </td>`
  purchaseTable.appendChild(row)
}

function calculateSummary() {
  let totalGold = 0, totalCost = 0
  purchaseTable.querySelectorAll('tr').forEach(row => {
    const cost = parseFloat(row.cells[1].innerText.replace(/[‚Çπ,]/g, '')) || 0
    const gold = parseFloat(row.cells[2].innerText.replace(' g', '')) || 0
    totalCost += cost; totalGold += gold
  })
  totalGoldEl.innerText = totalGold.toFixed(3)
  totalCostEl.innerText = formatCurrency(totalCost)
  const price = parseFloat(todayPriceInput.value)
  if (!price || price <= 0 || totalGold <= 0 || totalCost <= 0) {
    profitLossEl.innerText = "‚Çπ0.00"
    profitLossPercentEl.innerText = "0.00"
    currentValueEl.innerText = formatCurrency(totalCost)
    return
  }
  const currentValue = totalGold * price
  const profit = currentValue - totalCost
  const percent = (profit / totalCost) * 100
  profitLossEl.innerText = formatCurrency(profit)
  profitLossPercentEl.innerText = percent.toFixed(2)
  currentValueEl.innerText = formatCurrency(currentValue)
  profitLossEl.style.color = profit >= 0 ? 'lightgreen' : 'red'
  profitLossPercentEl.style.color = profit >= 0 ? 'lightgreen' : 'red'
}
todayPriceInput.addEventListener('input', calculateSummary)
</script>
</body>
</html>
