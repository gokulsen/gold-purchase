<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gold Purchase Tracker â€” Classic Blackâ€“Gold</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --gold:#d4af37;
  --light-gold:#f6e27a;
  --dark-gold:#b08d2a;
  --bg-grad: linear-gradient(135deg,#000,#111);
  --card-grad: linear-gradient(145deg,#111,#1c1c1c);
  --muted:#cfcfcf;
}

/* Reset + base */
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Poppins,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  background:var(--bg-grad);
  color:var(--muted);
  -webkit-font-smoothing:antialiased;
  min-height:100vh;
}

/* Header */
.header-bar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:14px 18px;
  background:linear-gradient(90deg,var(--gold),var(--dark-gold));
  box-shadow:0 3px 12px rgba(0,0,0,0.45);
}
.header-bar h1{
  margin:0;color:#000;font-size:1.15rem;font-weight:700;
  text-shadow:0 0 8px rgba(212,175,55,0.55);
}
.header-actions{display:flex;align-items:center;gap:12px;position:relative}
#userInfoBtn{
  display:none;
  background:rgba(0,0,0,0.05);
  border:1px solid rgba(0,0,0,0.06);
  padding:8px 12px;border-radius:10px;color:#000;font-weight:700;cursor:pointer;
}

/* Dropdown (only logout) */
.profile-dropdown{
  position:absolute;right:0;top:46px;min-width:200px;background:#0f0f0f;border:1px solid rgba(212,175,55,0.12);
  border-radius:10px;padding:6px;box-shadow:0 6px 20px rgba(0,0,0,0.6);display:none;z-index:999;
  transform-origin:top right;opacity:0;transform:translateY(-6px) scale(.98);
}
.profile-dropdown.active{display:block;opacity:1;transform:translateY(0) scale(1);transition:all .16s ease}
.profile-dropdown .item{display:block;padding:10px 12px;border-radius:8px;color:var(--muted);text-decoration:none;cursor:pointer}
.profile-dropdown .item:hover{background:rgba(212,175,55,0.06);color:var(--light-gold)}
.profile-dropdown .logout{color:#ffb3b3}

/* Layout container */
.container{max-width:1100px;margin:20px auto;padding:16px}

/* Summary cards */
.summary{display:flex;flex-wrap:wrap;gap:14px;justify-content:space-between;margin-bottom:20px}
.card{
  flex:1 1 calc(33.33% - 14px);min-width:220px;
  background:var(--card-grad);border-radius:12px;padding:14px;
  border:1px solid var(--dark-gold);text-align:center;box-shadow:0 0 18px rgba(212,175,55,0.12);
}
.card .label{font-size:13px;color:var(--muted);margin-bottom:6px}
.card .value{font-weight:700;color:var(--light-gold);font-size:1.15rem}
.card input{background:#000;border:1px solid var(--gold);color:var(--light-gold);padding:6px;border-radius:6px;text-align:center}
.card button{padding:6px 10px;border-radius:6px;border:none;background:linear-gradient(90deg,var(--gold),var(--dark-gold));cursor:pointer;color:#000;font-weight:700;margin-left:6px}

/* Chart area */
.chart-block{display:flex;flex-direction:column;gap:12px;margin-bottom:18px}
.chart-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.pill{background:rgba(255,255,255,0.03);color:var(--muted);border:1px solid rgba(255,255,255,0.03);padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:700}
.pill.active{background:linear-gradient(90deg,var(--gold),var(--light-gold));color:#000;border-color:var(--dark-gold);box-shadow:0 6px 18px rgba(0,0,0,0.35)}

/* Add purchase */
#addForm{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:20px 0;background:var(--card-grad);border:1px solid var(--dark-gold);border-radius:12px;padding:14px;box-shadow:0 0 15px rgba(212,175,55,0.08)}
#addForm input{background:#000;border:1px solid var(--dark-gold);color:var(--light-gold);padding:8px;border-radius:8px;width:160px;text-align:center}
#addForm button{background:linear-gradient(90deg,var(--gold),var(--dark-gold));border:none;color:#000;font-weight:700;border-radius:8px;padding:8px 14px;cursor:pointer}

/* Table */
table{width:100%;border-collapse:collapse;background:#111;border-radius:10px;overflow:hidden;box-shadow:0 0 18px rgba(212,175,55,0.12)}
th,td{padding:12px;text-align:center;color:var(--muted)}
th{background:linear-gradient(90deg,var(--gold),var(--dark-gold));color:#000}
tr:nth-child(even){background:#171717}
tr:hover{background:rgba(212,175,55,0.06)}
.action-btn{padding:6px 8px;border-radius:6px;border:none;cursor:pointer}
.delete-btn{background:#dc3545;color:#fff}

/* Auth (login/signup/reset) */
.auth-container{max-width:420px;margin:60px auto;background:#111;border-radius:12px;padding:0;overflow:hidden;border:1px solid rgba(212,175,55,0.12)}
.auth-card{display:none;padding:26px;text-align:center}
.auth-card.active{display:block}
.auth-form input{width:100%;margin:8px 0;padding:10px;border-radius:8px;border:1px solid var(--dark-gold);background:#000;color:var(--light-gold);text-align:center}
.auth-form button{width:100%;padding:10px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--gold),var(--dark-gold));color:#000;font-weight:700;cursor:pointer;margin-top:8px}

/* Goal progress */
.goal-progress-wrap{width:100%;max-width:460px;padding:10px;background:#0f0f0f;border-radius:10px;border:1px solid rgba(212,175,55,0.06)}
.progress-bar{width:100%;height:18px;border-radius:12px;background:linear-gradient(90deg,#222,#111);overflow:hidden;position:relative;border:1px solid rgba(255,255,255,0.03)}
.progress-fill{height:100%;width:0%;display:block;border-radius:12px;background:linear-gradient(90deg,rgba(212,175,55,0.32),rgba(212,175,55,0.65));box-shadow:0 6px 20px rgba(212,175,55,0.12) inset;transform-origin:left center;transition:width 900ms cubic-bezier(.2,.9,.2,1)}
.progress-glow{position:absolute;top:0;left:0;height:100%;width:100%;background:linear-gradient(90deg,rgba(255,255,255,0.06),rgba(255,255,255,0));mix-blend-mode:screen;pointer-events:none;opacity:0.6;animation:shimmer 2.4s linear infinite}
@keyframes shimmer{from{transform:translateX(-100%)}to{transform:translateX(100%)}}

/* Modal backdrop (for nothing now, but keep) */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:120}
.modal{background:#111;border:1px solid var(--gold);padding:18px;border-radius:10px;max-width:420px;min-width:260px;color:var(--muted)}
.modal h3{margin:0 0 8px;color:var(--gold)}
.modal p{margin:0 0 12px}

/* Toasts */
.toaster{position:fixed;right:18px;bottom:18px;z-index:150;display:flex;flex-direction:column;gap:10px;align-items:flex-end}
.toast{min-width:220px;padding:12px 14px;border-radius:10px;color:#000;background:linear-gradient(90deg,var(--gold),var(--light-gold));box-shadow:0 6px 18px rgba(0,0,0,0.35);font-weight:700;transform:translateY(24px);opacity:0;animation:slideFade .45s forwards}
.toast.error{background:linear-gradient(90deg,#ff6b6b,#ff8a8a);color:#fff}
@keyframes slideFade{to{transform:translateY(0);opacity:1}}

/* small screens */
@media(max-width:1024px){ .card{flex:1 1 calc(50% - 14px)} }
@media(max-width:720px){ .summary{flex-direction:column} .card{flex:1 1 100%} .header-bar h1{font-size:1rem} .profile-dropdown{right:8px} }
</style>
</head>
<body>
  <!-- Header -->
  <div class="header-bar">
    <h1>Gold Purchase Tracker</h1>
    <div class="header-actions">
      <button id="userInfoBtn">user@example.com â–¾</button>

      <!-- dropdown: just logout -->
      <div id="profileDropdown" class="profile-dropdown" aria-hidden="true">
        <div id="dropdownEmail" class="item" style="font-weight:700;color:#fff;cursor:default"></div>
        <div id="dropdownLogout" class="item logout">Logout ðŸšª</div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- AUTH AREA -->
    <div id="authContainer" class="auth-container">
      <!-- login -->
      <div id="loginDiv" class="auth-card active">
        <h2 style="color:var(--gold)">Welcome</h2>
        <form id="loginForm" class="auth-form">
          <input id="loginEmail" type="email" placeholder="Email" required />
          <input id="loginPassword" type="password" placeholder="Password" required />
          <button type="submit">Login</button>
        </form>
        <a href="#" id="forgotPassword" style="display:block;margin-top:8px;color:var(--light-gold)">Forgot Password?</a>
        <p style="margin-top:10px;color:var(--muted)">Don't have an account? <a href="#" id="showSignup" style="color:var(--light-gold)">Create one</a></p>
      </div>

      <!-- signup -->
      <div id="signupDiv" class="auth-card">
        <h2 style="color:var(--gold)">Sign Up</h2>
        <form id="signupForm" class="auth-form">
          <input id="signupEmail" type="email" placeholder="Email" required />
          <input id="signupPassword" type="password" placeholder="Password" required />
          <button type="submit">Create Account</button>
        </form>
        <p style="margin-top:10px;color:var(--muted)">Already have an account? <a href="#" id="showLogin" style="color:var(--light-gold)">Back to Login</a></p>
      </div>

      <!-- reset -->
      <div id="resetDiv" class="auth-card">
        <h2 style="color:var(--gold)">Reset Password</h2>
        <form id="resetForm" class="auth-form">
          <input id="resetEmail" type="email" placeholder="Your registered email" required />
          <button type="submit">Send Reset Link</button>
        </form>
        <p style="margin-top:10px;color:var(--muted)">Remembered? <a href="#" id="backToLogin" style="color:var(--light-gold)">Back to Login</a></p>
      </div>
    </div>

    <!-- APP -->
    <div id="appDiv" style="display:none;">
      <!-- summary cards -->
      <div class="summary">
        <div class="card"><div class="label">Total Gold</div><div class="value"><span id="totalGold">0</span> g</div></div>
        <div class="card"><div class="label">Total Cost</div><div class="value"><span id="totalCost">â‚¹0.00</span></div></div>
        <div class="card"><div class="label">Current Value</div><div class="value"><span id="currentValue">â‚¹0.00</span></div></div>
        <div class="card"><div class="label">Unrealized Profit / Loss</div><div class="value"><div id="profitValue" style="font-size:1.2rem;font-weight:700">â‚¹0.00</div><div id="profitPercentText" style="margin-top:6px;font-size:0.9rem;color:#bbb">â€”</div></div></div>

        <!-- goal card -->
        <div class="card">
          <div class="label">Your Gold Goal</div>
          <div style="color:var(--light-gold);font-weight:700;margin-top:6px" id="goalSummary">No goal set</div>
          <div class="goal-progress-wrap" style="margin-top:10px">
            <div class="progress-bar">
              <span class="progress-fill" id="progressFill"><span class="progress-glow"></span></span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:13px;color:#bbb"><span id="goalProgressText">0%</span><span id="goalETA"></span></div>
          </div>
          <div style="margin-top:10px;display:flex;gap:8px;justify-content:center">
            <input id="targetGrams" type="number" step="0.001" placeholder="Target grams" style="width:140px;padding:8px;border-radius:8px;background:#000;border:1px solid var(--dark-gold);color:var(--light-gold);text-align:center"/>
            <input id="targetDate" type="date" style="width:160px;padding:8px;border-radius:8px;background:#000;border:1px solid var(--dark-gold);color:var(--light-gold);text-align:center"/>
            <button id="saveGoal" style="padding:8px 12px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--gold),var(--dark-gold));color:#000;font-weight:700;cursor:pointer">Save</button>
          </div>
          <div style="margin-top:10px;color:#bbb;font-size:13px" id="goalSuggestion">â€”</div>
        </div>

        <!-- price card -->
		<div class="card">
		  <div class="label">Today's Sell Price</div>
		  <div style="display:flex;align-items:center;justify-content:center;gap:6px;flex-wrap:wrap;margin-top:6px">
			<input id="priceDate" type="date" required />
			<input id="sellPrice" type="number" step="0.01" placeholder="Sell Price â‚¹" required />
			<button id="savePrice">Save</button>
		  </div>
		  <small id="lastUpdated" style="color:#aaa;display:block;margin-top:8px"></small>
		</div>
      </div>

      <!-- chart -->
      <div class="chart-block">
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:6px">
          <strong style="color:var(--muted)">Filter chart:</strong>
          <div id="filterWeek" class="pill">Week</div>
          <div id="filterMonth" class="pill active">Month</div>
          <div id="filterYear" class="pill">Year</div>
        </div>
        <div style="height:320px;background:#0a0a0a;border-radius:12px;padding:12px">
          <canvas id="goldChart"></canvas>
        </div>
      </div>

      <!-- add purchase -->
		<form id="addForm">
		  <input id="purchaseDate" type="date" required />
		  <input id="buyPrice" type="number" step="0.01" placeholder="Buy Price â‚¹" required />
		  <input id="amount" type="text" placeholder="Amount â‚¹" required />
		  <input id="gold" type="number" step="0.001" placeholder="Gold (g)" required />
		  <button type="submit">Add Purchase</button>
		</form>

      <!-- table -->
      <table>
        <thead><tr><th>Date</th><th>Amount</th><th>Gold</th><th>Buy Price / g</th><th>Action</th></tr></thead>
        <tbody id="purchaseTable"></tbody>
      </table>
    </div>
  </div>

  <div class="confetti-wrap" id="confettiWrap"></div>
  <div class="toaster" id="toaster"></div>

<script type="module">
/* Full JS (uses Supabase) */
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

/* -------------------------
   Supabase init (your keys)
   ------------------------- */
const SUPABASE_URL = 'https://febpaanqrqgrnbyrvfxx.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlYnBhYW5xcnFncm5ieXJ2Znh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NDUzNzMsImV4cCI6MjA3NjUyMTM3M30.dFyrWiNKqGCVDGLN9HU2IyRuI6rqAJaZGwRQjXri3mQ'
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

/* ---------- DOM refs ---------- */
const userInfoBtn = document.getElementById('userInfoBtn')
const profileDropdown = document.getElementById('profileDropdown')
const dropdownEmail = document.getElementById('dropdownEmail')
const dropdownLogout = document.getElementById('dropdownLogout')

const authContainer = document.getElementById('authContainer')
const loginDiv = document.getElementById('loginDiv')
const signupDiv = document.getElementById('signupDiv')
const resetDiv = document.getElementById('resetDiv')
const loginForm = document.getElementById('loginForm')
const signupForm = document.getElementById('signupForm')
const resetForm = document.getElementById('resetForm')
const forgotPassword = document.getElementById('forgotPassword')
const showSignup = document.getElementById('showSignup')
const showLogin = document.getElementById('showLogin')
const backToLogin = document.getElementById('backToLogin')

const appDiv = document.getElementById('appDiv')
const purchaseTable = document.getElementById('purchaseTable')
const totalGoldEl = document.getElementById('totalGold')
const totalCostEl = document.getElementById('totalCost')
const currentValueEl = document.getElementById('currentValue')
const priceDateInput = document.getElementById('priceDate')
const savePriceBtn = document.getElementById('savePrice')
const lastUpdated = document.getElementById('lastUpdated')
const filterWeek = document.getElementById('filterWeek')
const filterMonth = document.getElementById('filterMonth')
const filterYear = document.getElementById('filterYear')
const addForm = document.getElementById('addForm')
const purchaseDateInput = document.getElementById('purchaseDate')
const amountInput = document.getElementById('amount')
const goldInput = document.getElementById('gold')

const targetGramsInput = document.getElementById('targetGrams')
const targetDateInput = document.getElementById('targetDate')
const saveGoalBtn = document.getElementById('saveGoal')
const goalSummary = document.getElementById('goalSummary')
const progressFill = document.getElementById('progressFill')
const goalProgressText = document.getElementById('goalProgressText')
const goalSuggestion = document.getElementById('goalSuggestion')

const toaster = document.getElementById('toaster')
const confettiWrap = document.getElementById('confettiWrap')
let goldChart = null

/* ---------- utils ---------- */
function showToast(message, type='success', timeout=3500){
  const el = document.createElement('div')
  el.className = 'toast' + (type === 'error' ? ' error' : '')
  el.innerText = message
  toaster.appendChild(el)
  setTimeout(()=>{ el.style.transition='opacity .35s, transform .35s'; el.style.opacity='0'; el.style.transform='translateY(-10px)'; setTimeout(()=>el.remove(),420) }, timeout)
}
const formatCurrency = n => new Intl.NumberFormat('en-IN', { style:'currency', currency:'INR', maximumFractionDigits:2 }).format(n || 0)
const unformatCurrency = s => typeof s === 'string' ? parseFloat(s.replace(/[â‚¹,\s]/g,'')) || 0 : Number(s) || 0
const formatDateISO = d => new Date(d).toISOString().split('T')[0]
function prettyDate(d){
  try {
    const dt = new Date(d)
    return dt.toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' })
  } catch(e){ return d }
}

/* ---------- small UI helpers ---------- */
function showCard(cardEl){ [loginDiv, signupDiv, resetDiv].forEach(c => c.classList.remove('active')); cardEl.classList.add('active') }
showSignup.addEventListener('click', e=>{ e.preventDefault(); showCard(signupDiv) })
showLogin.addEventListener('click', e=>{ e.preventDefault(); showCard(loginDiv) })
forgotPassword.addEventListener('click', e=>{ e.preventDefault(); showCard(resetDiv) })
backToLogin.addEventListener('click', e=>{ e.preventDefault(); showCard(loginDiv) })

/* ---------- AUTH flows ---------- */
let currentUser = null

async function checkUser(){
  const { data } = await supabase.auth.getSession()
  if (data?.session) {
    currentUser = data.session.user
    showApp(currentUser)
  } else {
    // show auth UI
    authContainer.style.display = 'block'
    appDiv.style.display = 'none'
    userInfoBtn.style.display = 'none'
  }
}
checkUser()

// Signup
signupForm.addEventListener('submit', async (ev) => {
  ev.preventDefault()
  const email = document.getElementById('signupEmail').value
  const password = document.getElementById('signupPassword').value
  const { error } = await supabase.auth.signUp({ email, password })
  if (error) { showToast(error.message, 'error'); return }
  showToast('Account created â€” check your email to confirm (if required).')
  showCard(loginDiv)
})

// Login
loginForm.addEventListener('submit', async (ev) => {
  ev.preventDefault()
  const email = document.getElementById('loginEmail').value
  const password = document.getElementById('loginPassword').value
  const { data, error } = await supabase.auth.signInWithPassword({ email, password })
  if (error) { showToast(error.message, 'error'); return }
  currentUser = data.user
  showToast('Login successful')
  showApp(currentUser)
})

// Reset request
resetForm.addEventListener('submit', async (ev) => {
  ev.preventDefault()
  const email = document.getElementById('resetEmail').value
  const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin })
  if (error) { showToast(error.message, 'error'); return }
  showToast('Reset link sent â€” check your inbox.')
  resetForm.reset()
  showCard(loginDiv)
})

/* ---------- DROPDOWN (Logout only) ---------- */
function setupDropdown(){
  userInfoBtn.style.display = 'none'
  profileDropdown.classList.remove('active')

  userInfoBtn.addEventListener('click', (e) => {
    e.stopPropagation()
    profileDropdown.classList.toggle('active')
  })
  document.addEventListener('click', (e) => {
    if (!profileDropdown.contains(e.target) && e.target !== userInfoBtn) profileDropdown.classList.remove('active')
  })
  dropdownLogout.addEventListener('click', async (e) => {
    e.preventDefault()
    profileDropdown.classList.remove('active')
    await supabase.auth.signOut()
    location.reload()
  })
}
setupDropdown()

/* ---------- Purchases CRUD ---------- */
async function loadPurchases(){
  const { data, error } = await supabase.from('gold_purchases').select('*').order('purchase_date', { ascending: true })
  if (error) { showToast(error.message, 'error'); return }
  purchaseTable.innerHTML = ''
  data.forEach(p => {
    const tr = document.createElement('tr')
	tr.innerHTML = `
	  <td>${p.purchase_date}</td>
	  <td>${formatCurrency(p.amount)}</td>
	  <td>${p.gold} g</td>
	  <td data-buy-price="${p.buy_price || 0}">â‚¹${p.buy_price?.toFixed(2) || '0.00'}</td>
	  <td><button class="action-btn delete-btn" onclick="deletePurchase(${p.id})">Delete</button></td>`
    purchaseTable.appendChild(tr)
  })
  calculateSummary()
}
window.deletePurchase = async function(id){
  const { error } = await supabase.from('gold_purchases').delete().eq('id', id)
  if (error) { showToast(error.message, 'error'); return }
  showToast('Purchase deleted')
  await loadPurchases()
  await loadUserGoal()
}

addForm.addEventListener('submit', async (ev) => {
  ev.preventDefault()
  const purchase_date = purchaseDateInput.value || formatDateISO(new Date())
  const amount = unformatCurrency(amountInput.value)
  const gold = parseFloat(goldInput.value)
  if (!purchase_date || !amount || isNaN(gold) || gold <= 0) return showToast('Enter valid purchase data', 'error')
  const { data: userData } = await supabase.auth.getUser()
  const user_id = userData?.user?.id || null
  const buy_price = parseFloat(document.getElementById('buyPrice').value)
  const {error}=await supabase.from('gold_purchases').insert([{purchase_date,amount,gold,buy_price,user_id}])
  if (error) { showToast(error.message, 'error'); return }
  showToast('Purchase added')
  addForm.reset()
  loadPurchases()
  loadUserGoal()
})

/* ---------- Gold price chart & management ---------- */
let chartFilter = 'month'
function computeStartDate(filter){
  const today = new Date()
  const start = new Date(today)
  if (filter === 'week') start.setDate(today.getDate() - 6)
  else if (filter === 'month') start.setDate(today.getDate() - 29)
  else start.setDate(today.getDate() - 364)
  return formatDateISO(start)
}
async function loadGoldPrice(filter = 'month'){
  chartFilter = filter
  const startDate = computeStartDate(filter)
  const { data, error } = await supabase.from('gold_price').select('*').gte('price_date', startDate).order('price_date', { ascending: true })
  if (error) { showToast(error.message, 'error'); return }
  drawGoldChart(data || [])
  if (data && data.length) {
  const latest = data[data.length - 1];
  document.getElementById('sellPrice').value = latest.sell_price || latest.price;
  priceDateInput.value = latest.price_date;
  lastUpdated.textContent = `Last updated: ${latest.price_date}`;
  } else lastUpdated.textContent = ''
  calculateSummary()
}
function drawGoldChart(data) {
  const ctx = document.getElementById('goldChart').getContext('2d');
  const labels = data.map(d => d.price_date);
  const buyPrices = data.map(d => d.price);
  const sellPrices = data.map(d => d.sell_price);

  if (goldChart) goldChart.destroy();

  goldChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Sell Price (â‚¹/g)',
          data: sellPrices,
          borderColor: '#ff6666',
          backgroundColor: 'rgba(255,102,102,0.08)',
          fill: true,
          tension: 0.3,
        }
      ]
    },
    options: {
      plugins: {
        legend: {
          labels: { color: '#f6e27a' }
        }
      },
      scales: {
        x: { ticks: { color: '#ccc' }, grid: { color: '#222' } },
        y: { ticks: { color: '#ccc' }, grid: { color: '#222' } }
      }
    }
  });
}

filterWeek.addEventListener('click', ()=>{ filterWeek.classList.add('active'); filterMonth.classList.remove('active'); filterYear.classList.remove('active'); loadGoldPrice('week') })
filterMonth.addEventListener('click', ()=>{ filterMonth.classList.add('active'); filterWeek.classList.remove('active'); filterYear.classList.remove('active'); loadGoldPrice('month') })
filterYear.addEventListener('click', ()=>{ filterYear.classList.add('active'); filterWeek.classList.remove('active'); filterMonth.classList.remove('active'); loadGoldPrice('year') })

savePriceBtn.addEventListener('click', async ()=>{
  const price = parseFloat(document.getElementById('sellPrice').value)
  const date = priceDateInput.value || formatDateISO(new Date())
  if (!price || price <= 0) { showToast('Enter valid gold price', 'error'); return }
  const { error } = await supabase
    .from('gold_price').upsert([{ price_date: date, sell_price: price }], { onConflict: ['price_date'] })
  if (error) { showToast('Error saving price: ' + error.message, 'error'); return }
  showToast('Gold price saved')
  await loadGoldPrice(chartFilter)
})

/* ---------- Summary & profit ---------- */
function calculateSummary() {
  let totalGold = 0, totalCost = 0;

  purchaseTable.querySelectorAll('tr').forEach(tr => {
    const tds = tr.querySelectorAll('td');
    const gold = parseFloat(tds[2].innerText) || 0;
    const buyPrice = parseFloat(tds[3]?.dataset?.buyPrice || 0);
    totalGold += gold;
    totalCost += gold * buyPrice;
  });

  totalGoldEl.innerText = totalGold.toFixed(3);
  totalCostEl.innerText = formatCurrency(totalCost);

  const sellPrice = parseFloat(document.getElementById('sellPrice').value);
  if (!sellPrice || sellPrice <= 0 || totalGold <= 0 || totalCost <= 0) {
    profitValue.innerText = "â‚¹0.00";
    profitPercentText.innerText = "â€”";
    profitValue.style.color = "#ccc";
    currentValueEl.innerText = formatCurrency(totalCost);
    return;
  }

  const currentValue = totalGold * sellPrice;
  const profit = currentValue - totalCost;
  const percent = (profit / totalCost) * 100;
  const isGain = profit >= 0;

  profitValue.style.color = isGain ? "lightgreen" : "#ff6666";
  profitValue.innerText = formatCurrency(profit);
  profitPercentText.innerHTML = `${isGain ? '+' : 'â€“'}${Math.abs(percent).toFixed(2)} % <span style="color:#aaa;">${isGain ? 'gain' : 'drop'}</span>`;
  currentValueEl.innerText = formatCurrency(currentValue);
}


/* ---------- Goal tracker ---------- */
async function loadUserGoal(){
  if (!currentUser) return
  const { data, error } = await supabase.from('user_goals').select('*').eq('user_id', currentUser.id).limit(1)
  if (error) return
  const goal = data?.[0] || null
  if (goal) {
    targetGramsInput.value = goal.target_grams
    targetDateInput.value = goal.target_date
    const gd = new Date(goal.target_date)
    const formatted = gd.toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' })
    goalSummary.innerText = `Target ${goal.target_grams}g by ${formatted}`
    window._currentGoal = goal
  } else {
    goalSummary.innerText = 'No goal set'
    window._currentGoal = null
  }
  updateGoalProgress()
}
saveGoalBtn.addEventListener('click', async ()=>{
  if (!currentUser) return showToast('Not signed in', 'error')
  const tg = parseFloat(targetGramsInput.value)
  const td = targetDateInput.value
  if (!tg || !td) return showToast('Invalid goal', 'error')
  const { data } = await supabase.from('user_goals').select('*').eq('user_id', currentUser.id).limit(1)
  if (data?.length) {
    const id = data[0].id
    const { error } = await supabase.from('user_goals').update({ target_grams: tg, target_date: td }).eq('id', id)
    if (error) return showToast(error.message, 'error')
    showToast('Goal updated')
  } else {
    const { error } = await supabase.from('user_goals').insert([{ user_id: currentUser.id, target_grams: tg, target_date: td }])
    if (error) return showToast(error.message, 'error')
    showToast('Goal saved')
  }
  await loadUserGoal()
})

function updateGoalProgress(){
  const currentGoal = window._currentGoal
  if (!currentGoal) {
    progressFill.style.width = '0%'
    goalProgressText.innerText = '0%'
    goalSuggestion.innerText = 'No goal set'
    return
  }
  let totalGold = 0
  purchaseTable.querySelectorAll('tr').forEach(tr => { totalGold += parseFloat(tr.children[2].innerText) || 0 })
  const pct = Math.min(100, (totalGold / currentGoal.target_grams) * 100)
  progressFill.style.width = pct + '%'
  goalProgressText.innerText = `${pct.toFixed(1)}% (${totalGold.toFixed(2)} / ${currentGoal.target_grams}g)`
  const rem = Math.max(0, currentGoal.target_grams - totalGold)
  const days = (new Date(currentGoal.target_date) - new Date()) / 86400000
  if (rem <= 0) {
    goalSuggestion.innerText = 'Goal achieved ðŸŽ‰'
    triggerGoalAchieved()
  } else if (days <= 0) {
    goalSuggestion.innerText = `Target date passed; ${rem.toFixed(2)}g left.`
  } else {
    const gpm = rem / Math.max(1, days / 30)
    const gpw = rem / Math.max(1, days / 7)
    goalSuggestion.innerText = `Invest ~${gpm.toFixed(2)}g/month or ${gpw.toFixed(2)}g/week`
  }
}

let _celebrated = false
function triggerGoalAchieved(){
  if (_celebrated) return
  _celebrated = true
  showToast('ðŸŽ‰ Goal Achieved!')
  const colors = ['#d4af37','#f6e27a','#ffd966','#b08d2a']
  for (let i=0;i<70;i++){
    const e = document.createElement('div'); e.className = 'confetti-piece'
    e.style.background = colors[Math.floor(Math.random()*colors.length)]
    e.style.left = Math.random()*100 + '%'; e.style.top = '-10%'
    confettiWrap.appendChild(e)
    const dx = (Math.random()-0.5)*200, dur = 2000 + Math.random()*1600
    e.animate([{ transform: `translate3d(0,0,0) rotate(${Math.random()*360}deg)` }, { transform: `translate3d(${dx}px,${innerHeight+100}px,0) rotate(${Math.random()*720}deg)`, opacity: 0.3 }], { duration: dur, easing: 'ease-out' })
    setTimeout(()=>e.remove(), dur+600)
  }
  setTimeout(()=>_celebrated=false, 8000)
}

/* ---------- small helpers & init ---------- */
function setTodayInputs(){
  if (purchaseDateInput) purchaseDateInput.value = formatDateISO(new Date())
  if (priceDateInput) priceDateInput.value = formatDateISO(new Date())
}
setTodayInputs()

/* ---------- showApp & initial loads ---------- */
function showApp(user){
  currentUser = user
  authContainer.style.display = 'none'
  appDiv.style.display = 'block'
  userInfoBtn.style.display = 'inline-block'
  const displayEmail = user.email || (user.user && user.user.email) || ''
  userInfoBtn.textContent = displayEmail + ' â–¾'
  dropdownEmail.textContent = displayEmail
  // set default dates and formatting
  setTodayInputs()
  // load data
  setTimeout(()=>{ loadPurchases(); loadGoldPrice(chartFilter); loadUserGoal() }, 60)
}

/* Detect password recovery link (optional UX) */
(function detectRecoveryFlow(){
  const hash = window.location.hash || ''
  if (hash.includes('type=recovery') || hash.includes('access_token')) {
    showToast('Open the app via the link to complete password reset (follow Supabase flow).', 'success', 4500)
  }
})()

/* initial check (runs earlier too) */
checkUser()

</script>
</body>
</html>
