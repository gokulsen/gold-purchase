<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gold Purchase Tracker</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    h1 { text-align: center; }
    .summary { margin-bottom: 20px; padding: 10px; background: #fff; border-radius: 8px; box-shadow: 0 0 5px #ccc; display: flex; gap: 20px; justify-content: space-around; flex-wrap: wrap; }
    .summary div { display: flex; align-items: center; gap: 5px; }
    .summary input { width: 100px; padding: 4px; }
    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 0 5px #ccc; }
    th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: center; }
    th { background: #f0c040; color: #000; }
    tr:last-child td { border-bottom: none; }
    #addForm { margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap; }
    #addForm input, #addForm button { padding: 8px; font-size: 14px; }
    button { cursor: pointer; background: #f0c040; border: none; border-radius: 5px; padding: 5px 10px; }
    button:hover { background: #e6b800; }
</style>
</head>
<body>
<h1>Gold Purchase Tracker</h1>

<div class="summary">
    <div>Total Gold: <span id="totalGold">0</span> g</div>
    <div>Total Cost: ₹<span id="totalCost">0</span></div>
    <div>
        Today's Gold Price: ₹<input type="number" id="todayPrice" step="0.01" value="6200">
    </div>
    <div>Profit/Loss: ₹<span id="profitLoss">0</span></div>
    <div>Profit/Loss %: <span id="profitLossPercent">0</span>%</div>
</div>

<form id="addForm">
    <input type="date" id="purchaseDate" required>
    <input type="number" step="0.01" id="amount" placeholder="Amount ₹" required>
    <input type="number" step="0.001" id="gold" placeholder="Gold g" required>
    <button type="submit">Add Purchase</button>
</form>

<table>
    <thead>
        <tr>
            <th>Purchase Date</th>
            <th>Amount (₹)</th>
            <th>Gold (g)</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="purchaseTable"></tbody>
</table>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabaseUrl = 'https://febpaanqrqgrnbyrvfxx.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlYnBhYW5xcnFncm5ieXJ2Znh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NDUzNzMsImV4cCI6MjA3NjUyMTM3M30.dFyrWiNKqGCVDGLN9HU2IyRuI6rqAJaZGwRQjXri3mQ'
const supabase = createClient(supabaseUrl, supabaseKey)

const addForm = document.getElementById('addForm')
const purchaseTable = document.getElementById('purchaseTable')
const totalGoldEl = document.getElementById('totalGold')
const totalCostEl = document.getElementById('totalCost')
const todayPriceInput = document.getElementById('todayPrice')
const profitLossEl = document.getElementById('profitLoss')
const profitLossPercentEl = document.getElementById('profitLossPercent')

let editingId = null // Track if we are editing a row

// Load purchases from Supabase
async function loadPurchases() {
    const { data, error } = await supabase
        .from('gold_purchases')
        .select('*')
        .order('purchase_date', { ascending: true })

    if (error) { console.error(error); return }

    purchaseTable.innerHTML = ''
    data.forEach(p => addRowToTable(p))
    calculateSummary()
}

// Add a row to the table with edit/delete buttons
function addRowToTable(purchase) {
    const row = document.createElement('tr')
    row.dataset.id = purchase.id
    row.innerHTML = `
        <td>${purchase.purchase_date}</td>
        <td>₹${parseFloat(purchase.amount).toFixed(2)}</td>
        <td>${parseFloat(purchase.gold).toFixed(3)} g</td>
        <td>
            <button onclick="editRow(${purchase.id})">Edit</button>
            <button onclick="deleteRow(${purchase.id})">Delete</button>
        </td>
    `
    purchaseTable.appendChild(row)
}

// Calculate totals and profit/loss
function calculateSummary() {
    let totalGold = 0
    let totalCost = 0
    purchaseTable.querySelectorAll('tr').forEach(row => {
        const amount = parseFloat(row.cells[1].innerText.replace('₹',''))
        const gold = parseFloat(row.cells[2].innerText.replace(' g',''))
        totalGold += gold
        totalCost += amount
    })

    totalGoldEl.innerText = totalGold.toFixed(3)
    totalCostEl.innerText = totalCost.toFixed(2)

    const todayPrice = parseFloat(todayPriceInput.value)
    if (!isNaN(todayPrice)) {
        const profitLoss = (totalGold * todayPrice) - totalCost
        profitLossEl.innerText = profitLoss.toFixed(2)
        const profitPercent = totalCost > 0 ? (profitLoss / totalCost) * 100 : 0
        profitLossPercentEl.innerText = profitPercent.toFixed(2)
    } else {
        profitLossEl.innerText = '0'
        profitLossPercentEl.innerText = '0'
    }
}

// Delete a row from Supabase and table
window.deleteRow = async (id) => {
    if (!confirm('Are you sure you want to delete this purchase?')) return
    const { error } = await supabase
        .from('gold_purchases')
        .delete()
        .eq('id', id)
    if (error) { alert('Error deleting row'); console.error(error); return }
    loadPurchases()
}

// Edit a row
window.editRow = (id) => {
    const row = purchaseTable.querySelector(`tr[data-id='${id}']`)
    if (!row) return

    // Pre-fill form with row data
    document.getElementById('purchaseDate').value = row.cells[0].innerText
    document.getElementById('amount').value = parseFloat(row.cells[1].innerText.replace('₹',''))
    document.getElementById('gold').value = parseFloat(row.cells[2].innerText.replace(' g',''))
    editingId = id
    addForm.querySelector('button').innerText = 'Update Purchase'
}

// Handle form submit (Add or Update)
addForm.addEventListener('submit', async (e) => {
    e.preventDefault()
    const purchaseDate = document.getElementById('purchaseDate').value
    const amount = parseFloat(document.getElementById('amount').value)
    const gold = parseFloat(document.getElementById('gold').value)

    if (editingId) {
        // Update existing row
        const { error } = await supabase
            .from('gold_purchases')
            .update({ purchase_date: purchaseDate, amount, gold })
            .eq('id', editingId)
        if (error) { alert('Error updating row'); console.error(error); return }
        editingId = null
        addForm.querySelector('button').innerText = 'Add Purchase'
    } else {
        // Insert new row
        const { data, error } = await supabase
            .from('gold_purchases')
            .insert([{ purchase_date: purchaseDate, amount, gold }])
        if (error) { alert('Error adding purchase'); console.error(error); return }
    }

    addForm.reset()
    loadPurchases()
})

// Recalculate when today's price changes
todayPriceInput.addEventListener('input', calculateSummary)

// Initialize
loadPurchases()
</script>
</body>
</html>
